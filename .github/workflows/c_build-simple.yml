name: C 語言編碼與解碼流程

on: [push]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 步驟 1: 取得 repo 程式碼
      - name: Checkout code
        uses: actions/checkout@v4

      # 步驟 2: 編譯 encoder.c（加入 logger.c 和 math 函式庫）
      - name: Compile encoder
        run: gcc encoder.c logger.c -lm -g -o encoder

      # 步驟 3: 上傳 encoder
      - name: Upload encoder binary
        uses: actions/upload-artifact@v4
        with:
          name: encoder
          path: encoder

      # 步驟 4: 編譯 decoder.c（加入 logger.c 和 math 函式庫）
      - name: Compile decoder
        run: gcc decoder.c logger.c -lm -g -o decoder

      # 步驟 5: 上傳 decoder
      - name: Upload decoder binary
        uses: actions/upload-artifact@v4
        with:
          name: decoder
          path: decoder

      # 步驟 6: 執行 encoder 處理輸入資料
      - name: Run encoder
        run: ./encoder test_input_simple.txt test_codebook-simple.csv encoder.log test_encoded-simple.bin


      # 步驟 7: 上傳 encoder 輸出結果
      - name: Upload encoder outputs
        uses: actions/upload-artifact@v4
        with:
          name: encoder-outputs
          path: |
            test_encoded-simple.bin
            test_codebook-simple.csv
            encoder.log

      # 步驟 8: 執行 decoder 處理編碼資料
      - name: Run decoder
        run: ./decoder test_output-simple.txt test_codebook-simple.csv test_encoded-simple.bin


      # 步驟 9: 上傳 decoder 輸出結果
      - name: Upload decoder outputs
        uses: actions/upload-artifact@v4
        with:
          name: decoder-outputs
          path: |
            test_output-simple.txt
            decoder.log

      # 步驟 10: 比較解碼後的輸出與原始輸入是否相同
      - name: Compare decoded output with original input
        run: |
              if diff test_input_simple.txt test_output-simple.txt > /dev/null; then
                echo "一樣"
              else
                echo 不一樣"
                exit 1
              fi

